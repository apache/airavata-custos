---
- name: get current entry for audit
  test_win_security_policy:
    section: Event Audit
    key: AuditSystemEvents
  register: before_value_audit

- name: get current entry for guest
  test_win_security_policy:
    section: System Access
    key: NewGuestName
  register: before_value_guest

- name: get current value for the LegalNoticeText
  ansible.windows.win_reg_stat:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: LegalNoticeText
  register: original_legal_notice

- block:
  - name: set AuditSystemEvents entry before tests
    win_security_policy:
      section: Event Audit
      key: AuditSystemEvents
      value: 0

  - name: set NewGuestName entry before tests
    win_security_policy:
      section: System Access
      key: NewGuestName
      value: Guest

  - name: set LegalNoticeText with non-ASCII chars
    ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
      name: LegalNoticeText
      data: "Légal Noticé\r\nNewline"

  - name: run tests
    include_tasks: tests.yml

  # https://github.com/ansible-collections/community.windows/issues/153
  - name: get the value for the LegalNoticeText after running tests
    ansible.windows.win_reg_stat:
      path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
      name: LegalNoticeText
    register: legal_notice

  - name: verify the non-ASCII chars weren't corrupted
    assert:
      that:
      - legal_notice.value == "Légal Noticé\r\nNewline"

  always:
  - name: reset entries for AuditSystemEvents
    win_security_policy:
      section: Event Audit
      key: AuditSystemEvents
      value: "{{before_value_audit.value}}"

  - name: reset entries for NewGuestName
    win_security_policy:
      section: System Access
      key: NewGuestName
      value: "{{before_value_guest.value}}"

  - name: reset LegalNoticeText
    ansible.windows.win_regedit:
      path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
      name: LegalNoticeText
      data: '{{ original_legal_notice.value }}'
