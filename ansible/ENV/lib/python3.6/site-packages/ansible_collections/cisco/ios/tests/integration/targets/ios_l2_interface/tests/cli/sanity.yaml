---
- debug: msg="START connection={{ ansible_connection }} ios_l2_interface sanity
    test"

- name: Setup interface
  cisco.ios.ios_config: &id009
    lines:
      - default interface {{ test_interface }}
    provider: '{{ cli }}'

- name: set trunk encapsulation type
  cisco.ios.ios_config:
    lines:
      - switchport trunk encapsulation dot1q
    parents:
      - interface {{ test_interface }}
    provider: '{{ cli }}'

- name: Setup vlans
  cisco.ios.ios_vlan:
    aggregate:

      - vlan_id: 5

      - vlan_id: 6

      - vlan_id: 7

      - vlan_id: 8

      - vlan_id: 9

      - vlan_id: 10

      - vlan_id: 20
    provider: '{{ cli }}'

- block:

    - name: Ensure interface is in its default switchport state
      cisco.ios.ios_l2_interface: &id008
        name: '{{ test_interface }}'
        state: unconfigured
        provider: '{{ cli }}'

    - name: Ensure interface is configured for access vlan 20
      register: result
      cisco.ios.ios_l2_interface: &id001
        name: '{{ test_interface }}'
        mode: access
        access_vlan: 20
        provider: '{{ cli }}'

    - assert: &id002
        that:
          - result.changed == true

    - name: access vlan Idempotence
      register: result
      cisco.ios.ios_l2_interface: *id001

    - assert: &id004
        that:
          - result.changed == false

    - name: Ensure interface only has vlans 5-10 as trunk vlans
      register: result
      cisco.ios.ios_l2_interface: &id003
        name: '{{ test_interface }}'
        mode: trunk
        native_vlan: 10
        trunk_allowed_vlans: 5-10
        provider: '{{ cli }}'

    - assert: *id002

    - name: trunk vlan Idempotence
      register: result
      cisco.ios.ios_l2_interface: *id003

    - assert: *id004

    - name: Ensure interface is a trunk port and ensure 2-50 are being tagged (doesn't
        mean others aren't also being tagged)
      register: result
      cisco.ios.ios_l2_interface: &id005
        name: '{{ test_interface }}'
        mode: trunk
        native_vlan: 10
        trunk_vlans: 2-50
        provider: '{{ cli }}'

    - assert: *id002

    - name: tag vlan Idempotence
      register: result
      cisco.ios.ios_l2_interface: *id005

    - assert: *id004

    - name: Remove full trunk vlan range 2-50
      register: result
      cisco.ios.ios_l2_interface: &id006
        name: '{{ test_interface }}'
        mode: trunk
        trunk_vlans: 2-50
        state: absent
        provider: '{{ cli }}'

    - assert: *id002

    - name: Check Idempotence Remove full trunk vlan range 2-50
      register: result
      cisco.ios.ios_l2_interface: *id006

    - assert: *id004

    - name: Reconfigure interface trunk port and ensure 2-50 are being tagged
      register: result
      cisco.ios.ios_l2_interface: *id005

    - assert: *id002

    - name: Check Idempotence Reconfigure interface trunk port and ensure 2-50 are
        being tagged
      register: result
      cisco.ios.ios_l2_interface: *id005

    - assert: *id004

    - name: Remove partial trunk vlan range 30-4094 are removed
      register: result
      cisco.ios.ios_l2_interface: &id007
        name: '{{ test_interface }}'
        mode: trunk
        trunk_vlans: 30-4094
        state: absent
        provider: '{{ cli }}'

    - assert: *id002

    - name: Check Idempotence Remove partial trunk vlan range 30-4094 are removed
      register: result
      cisco.ios.ios_l2_interface: *id007

    - assert: *id004

    - name: put interface default state
      register: result
      cisco.ios.ios_l2_interface: *id008

    - assert: *id002

    - name: default state idempotence
      register: result
      cisco.ios.ios_l2_interface: *id008

    - assert: *id004
  always:

    - name: remove vlans
      ignore_errors: true
      cisco.ios.ios_vlan:
        aggregate:

          - vlan_id: 5

          - vlan_id: 6

          - vlan_id: 7

          - vlan_id: 8

          - vlan_id: 9

          - vlan_id: 10

          - vlan_id: 20
        state: absent
        provider: '{{ cli }}'

    - name: default interface
      ignore_errors: true
      cisco.ios.ios_config: *id009

- debug: msg="END connection={{ ansible_connection }} ios_l2_interface sanity test"
