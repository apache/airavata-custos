# Test code for the na_santricity_lun_mapping module
# (c) 2020, NetApp, Inc
# BSD-3 Clause (see COPYING or https://opensource.org/licenses/BSD-3-Clause)
- name: Set facts for na_santricity_host module's intergration test.
  set_fact:
    credentials: &creds
      ssid: "{{ ssid }}"
      api_url: "{{ base_url }}"
      api_username: "{{ username }}"
      api_password: "{{ password }}"
      validate_certs: "{{ validate_cert }}"

# ****************************************************
# *** Setup test hosts, storage pools, and volumes ***
# ****************************************************
- name: Create host for host mapping
  na_santricity_host:
    <<: *creds
    state: present
    name: test_host_mapping_host
    host_type: 27
- na_santricity_host:
    <<: *creds
    state: present
    name: test_host1
    host_type: 27
- na_santricity_host:
    <<: *creds
    state: present
    name: test_host2
    host_type: 27
- name: Create storage pool for host mapping
  na_santricity_storagepool:
    <<: *creds
    state: present
    name: test_host_mapping_storage_pool
    raid_level: raid0
    criteria_min_usable_capacity: 1
- name: Create volume for host mapping
  na_santricity_volume:
    <<: *creds
    state: present
    name: test_host_mapping_volume
    storage_pool_name: test_host_mapping_storage_pool
    size: 1
- name: Create volume for host mapping
  na_santricity_volume:
    <<: *creds
    state: present
    name: test_host_mapping_volume2
    storage_pool_name: test_host_mapping_storage_pool
    size: 1

# **********************************************
# *** Create new lun between host and volume ***
# **********************************************
- name: Create na_santricity_lun_mapping
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

# QUICK VERIFICATION OF MISMATCHING TARGET/TARGET_TYPE - GOOD
#- name: Create na_santricity_lun_mapping
#  na_santricity_lun_mapping:
#    <<: *creds
#    state: present
#    target: test_host_mapping_host
#    volume: test_host_mapping_volume
#    lun: 100
#    target_type: group
#  register: result
#
#- pause: seconds=30
# **************************************************************
# *** Repeat previous lun creation play and verify unchanged ***
# **************************************************************
- name: Repeat lun creation
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] and result.changed==False }}"
    msg: "Lun failed to be unchanged."
  loop: "{{ lookup('list', current.json)}}"

# ****************************************************************
# *** Move existing lun to default target and verify unchanged ***
# ****************************************************************
- name: Move lun to default target
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    volume: test_host_mapping_volume
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

# *****************************************************************
# *** Move existing lun to specific target and verify unchanged ***
# *****************************************************************
- name: Move lun to default target
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

# *******************************************
# *** Modify a volume mapping's lun value ***
# *******************************************
- name: Change volume mapping's lun value
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    lun: 100
  register: result

- pause: seconds=15

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ result.changed }}"
    msg: "Lun failed to be unchanged."
  loop: "{{ lookup('list', current.json)}}"

- name: Verify mapping fails when lun already in use on existing host object
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume2
    lun: 100
  register: result
  ignore_errors: True

- pause: seconds=15

- assert:
    that: "{{ not result.changed }}"
    msg: "Lun succeeded when it should have failed."
  loop: "{{ lookup('list', current.json)}}"

- name: Verify mapping succeeds when the same lun is used on multiple host objects.
  na_santricity_lun_mapping:
    <<: *creds
    state: present
    target: test_host1
    volume: test_host_mapping_volume2
    lun: 100
  register: result

- pause: seconds=15

- assert:
    that: "{{ result.changed }}"
    msg: "Lun failed to be unchanged."
  loop: "{{ lookup('list', current.json)}}"

# *************************************************************************************************
# *** Verify that exact mapping details but different lun results in an unchanged configuration ***
# *************************************************************************************************
- name: Verify that exact mapping details but different lun results in an unchanged configuration
  na_santricity_lun_mapping:
    <<: *creds
    state: absent
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    lun: 99
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] and not result.changed }}"
    msg: "Lun failed to be unchanged."
  loop: "{{ lookup('list', current.json)}}"

# ********************************
# *** Delete newly created lun ***
# ********************************
- name: Delete lun creation
  na_santricity_lun_mapping:
    <<: *creds
    state: absent
    target: test_host_mapping_host
    volume: test_host_mapping_volume
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}storage-systems/{{ credentials.ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ not item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

# ********************************************************
# *** Tear down test hosts, storage pools, and volumes ***
# ********************************************************
- name: Delete volume for host mapping
  na_santricity_volume:
    <<: *creds
    state: absent
    name: test_host_mapping_volume
    storage_pool_name: test_host_mapping_storage_pool
    size: 1
- name: Delete volume for host mapping
  na_santricity_volume:
    <<: *creds
    state: absent
    name: test_host_mapping_volume2
    storage_pool_name: test_host_mapping_storage_pool
    size: 1
- name: Delete storage pool for host mapping
  na_santricity_storagepool:
    <<: *creds
    state: absent
    name: test_host_mapping_storage_pool
    raid_level: raid0
    criteria_min_usable_capacity: 1
- name: Delete host for host mapping
  na_santricity_host:
    <<: *creds
    state: absent
    name: test_host_mapping_host
    host_type_index: 27
- name: Delete host for host mapping
  na_santricity_host:
    <<: *creds
    state: absent
    name: test_host2
    host_type_index: 27
- name: Delete host for host mapping
  na_santricity_host:
    <<: *creds
    state: absent
    name: test_host1
    host_type_index: 27