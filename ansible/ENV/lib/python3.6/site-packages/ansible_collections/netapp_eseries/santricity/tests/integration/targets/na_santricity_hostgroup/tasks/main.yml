# Test code for the na_santricity_hostgroup module
# (c) 2020, NetApp, Inc
# BSD-3 Clause (see COPYING or https://opensource.org/licenses/BSD-3-Clause)
- name: Set facts for na_santricity_host module's intergration test.
  set_fact:
    credentials: &creds
      ssid: "{{ ssid }}"
      api_url: "{{ base_url }}"
      api_username: "{{ username }}"
      api_password: "{{ password }}"
      validate_certs: "{{ validate_cert }}"

- name: Setup hosts for the groups
  block:
    - name: Create iSCSI host
      na_santricity_host:
        <<: *creds
        name: windows_iscsi_host
        host_type: Windows
        ports:
          - type: iscsi
            label: iscsi_p1
            port: iqn.windows.host.com.1
          - type: iscsi
            label: iscsi_p2
            port: iqn.windows.host.com.2
    - name: Create FC host
      na_santricity_host:
        <<: *creds
        name: linux_fc_host
        host_type: Linux dm-mp
        ports:
          - type: fc
            label: fc_p1
            port: "0x1122334455667788"
          - type: fc
            label: fc_p2
            port: "01:23:45:67:89:1a:bc:de"

- name: Create host group and add one host (change)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - windows_iscsi_host
  register: results
- name: Verify results
  assert:
    that: "{{ results['changed'] }}"
    msg: "Unexpected results!"

- name: (Repeat) Create host group and add one host (no change)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - windows_iscsi_host
  register: results
- name: Verify results
  assert:
    that: "{{ not results['changed'] }}"
    msg: "Unexpected results!"

- name: Add one host (change, check_mode)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - windows_iscsi_host
      - linux_fc_host
  register: results
  check_mode: true
- name: Verify results
  assert:
    that: "{{ results['changed'] }}"
    msg: "Unexpected results!"

- name: Add one host (change, check_mode)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - windows_iscsi_host
      - linux_fc_host
  register: results
  check_mode: true
- name: Verify results
  assert:
    that: "{{ results['changed'] }}"
    msg: "Unexpected results!"

- name: Add one host (change)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - windows_iscsi_host
      - linux_fc_host
  register: results
- name: Verify results
  assert:
    that: "{{ results['changed'] }}"
    msg: "Unexpected results!"

- name: Remove one host (change)
  na_santricity_hostgroup:
    <<: *creds
    name: hostgroup_test
    hosts:
      - linux_fc_host
  register: results
- name: Verify results
  assert:
    that: "{{ results['changed'] }}"
    msg: "Unexpected results!"

- name: Delete host group (change)
  na_santricity_hostgroup:
    <<: *creds
    state: absent
    name: hostgroup_test

- name: Delete hosts for the groups
  block:
    - name: Delete iSCSI host
      na_santricity_host:
        <<: *creds
        state: absent
        name: windows_iscsi_host
      register: results

    - name: Delete FC host
      na_santricity_host:
        <<: *creds
        state: absent
        name: linux_fc_host
      register: results
